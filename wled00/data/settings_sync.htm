<!DOCTYPE html>
<html lang="en">
<head>
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport">
	<meta charset="utf-8">
	<title>Настройки синхронизации</title>
	<script>var d=document;
	var loc = false, locip, locproto = "http:";
	function gId(s){return d.getElementById(s);}
	function toggle(el){gId(el).classList.toggle("hide"); gId('No'+el).classList.toggle("hide");}
	function H(){window.open("https://kno.wled.ge/interfaces/udp-notifier/");}
	function B(){window.open(getURL("/settings"),"_self");}
	function adj(){if (d.Sf.DI.value == 6454) {if (d.Sf.EU.value == 1) d.Sf.EU.value = 0;}
					else if (d.Sf.DI.value == 5568) {if (d.Sf.DA.value == 0) d.Sf.DA.value = 1; if (d.Sf.EU.value == 0) d.Sf.EU.value = 1;} }
	// https://www.educative.io/edpresso/how-to-dynamically-load-a-js-file-in-javascript
	function loadJS(FILE_URL, async = true) {
		let scE = d.createElement("script");
		scE.setAttribute("src", FILE_URL);
		scE.setAttribute("type", "text/javascript");
		scE.setAttribute("async", async);
		d.body.appendChild(scE);
		// success event 
		scE.addEventListener("load", () => {
			//console.log("File loaded");
			GetV();SetVal();
		});
		// error event
		scE.addEventListener("error", (ev) => {
			console.log("Error on loading file", ev);
			alert("Ошибка загрузки настроек скрипты.\nНеполные данные страницы!");
		});
	}
	function FC()
	{
		for(j=0;j<8;j++)
		{
			gId("G"+(j+1)).checked=gId("GS").value>>j&1;
			gId("R"+(j+1)).checked=gId("GR").value>>j&1;
		}
	}
	function GC()
	{
		var a=0, b=0;

		var m=1;
		for(j=0;j<8;j++)
		{
			a+=gId("G"+(j+1)).checked*m;
			b+=gId("R"+(j+1)).checked*m;
			m*=2;
		}
		gId("GS").value=a;
		gId("GR").value=b;
	}
	function SP(){var p = d.Sf.DI.value; gId("xp").style.display = (p > 0)?"none":"block"; if (p > 0) d.Sf.EP.value = p;}
	function SetVal(){switch(parseInt(d.Sf.EP.value)){case 5568: d.Sf.DI.value = 5568; break; case 6454: d.Sf.DI.value = 6454; break; case 4048: d.Sf.DI.value = 4048; break; }; SP();FC();}
	function S(){
		let l = window.location;
		if (l.protocol == "file:") {
			loc = true;
			locip = localStorage.getItem('locIp');
			if (!locip) {
				locip = prompt("Режим файла. Введите IP адрес для устройства!");
				localStorage.setItem('locIp', locip);
			}
		} else {
			// detect reverse proxy
			let paths = l.pathname.slice(1,l.pathname.endsWith('/')?-1:undefined).split("/");
			if (paths.length > 2) {
				locproto = l.protocol;
				loc = true;
				locip = l.hostname + (l.port ? ":" + l.port : "") + "/" + paths[0];
			}
		}
		loadJS(getURL('/settings/s.js?p=4'), false);	// If we set async false, file is loaded and executed, then next statement is processed
		if (loc) d.Sf.action = getURL('/settings/sync');
	}
	function getURL(path) {
		return (loc ? locproto + "//" + locip : "") + path;
	}
	</script>
	<style>@import url("style.css");</style>
</head>
<body onload="S()">
<form id="form_s" name="Sf" method="post" onsubmit="GC()">
<div class="toprow">
<div class="helpB"><button type="button" onclick="H()">?</button></div>
<button type="button" onclick="B()">Назад</button><button type="submit">Сохранить</button><hr>
</div>
<h2>Настройка синхронизации</h2>
<h3>WLED трансляция</h3>
UDP порт: <input name="UP" type="number" min="1" max="65535" class="d5" required><br>
второй порт: <input name="U2" type="number" min="1" max="65535" class="d5" required><br>
<h3>Группы синхронизации:</h3>
<input name="GS" id="GS" type="number" style="display: none;"><!-- hidden inputs for bitwise group checkboxes -->
<input name="GR" id="GR" type="number" style="display: none;">
<table style="margin: 0 auto;">
	<tr>
		<td></td>
		<td>1</td>
		<td>2</td>
		<td>3</td>
		<td>4</td>
		<td>5</td>
		<td>6</td>
		<td>7</td>
		<td>8</td>
	</tr>
	<tr>
		<td>Отправить:</td>
		<td><input type="checkbox" id="G1" name="G1"></td>
		<td><input type="checkbox" id="G2" name="G2"></td>
		<td><input type="checkbox" id="G3" name="G3"></td>
		<td><input type="checkbox" id="G4" name="G4"></td>
		<td><input type="checkbox" id="G5" name="G5"></td>
		<td><input type="checkbox" id="G6" name="G6"></td>
		<td><input type="checkbox" id="G7" name="G7"></td>
		<td><input type="checkbox" id="G8" name="G8"></td>
	</tr>
	<tr>
		<td>Получить:</td>
		<td><input type="checkbox" id="R1" name="R1"></td>
		<td><input type="checkbox" id="R2" name="R2"></td>
		<td><input type="checkbox" id="R3" name="R3"></td>
		<td><input type="checkbox" id="R4" name="R4"></td>
		<td><input type="checkbox" id="R5" name="R5"></td>
		<td><input type="checkbox" id="R6" name="R6"></td>
		<td><input type="checkbox" id="R7" name="R7"></td>
		<td><input type="checkbox" id="R8" name="R8"></td>
	</tr>
</table><br>
Получить: <nowrap><input type="checkbox" name="RB">Яркость,</nowrap> <nowrap><input type="checkbox" name="RC">Цвет,</nowrap> <nowrap>и <input type="checkbox" name="RX">Эффекты</nowrap><br>
<input type="checkbox" name="SO">Настройки сегмента, <input type="checkbox" name="SG"> границы<br>
Отправлять уведомления при прямом изменении: <input type="checkbox" name="SD"><br>
Отправлять уведомления при нажатии на кнопку или IR: <input type="checkbox" name="SB"><br>
Отправлять уведомления Алексы: <input type="checkbox" name="SA"><br>
Отправлять уведомления изменения Philips Hue: <input type="checkbox" name="SH"><br>
Отправлять уведомления Macro: <input type="checkbox" name="SM"><br>
UDP пакеты переотправления: <input name="UR" type="number" min="0" max="30" class="d5" required><br><br>
<i>Для применения изменений требуется перезапуск. </i>
<hr class="sml">
<h3>Список инстансов</h3>
Включить список инстансов: <input type="checkbox" name="NL"><br>
Сделать инстанс открываемым: <input type="checkbox" name="NB">
<hr class="sml">
<h3>Наст. время</h3>
Получать UDP наст. время: <input type="checkbox" name="RD"><br>
Использовать только главный сегмент: <input type="checkbox" name="MO"><br><br>
<i>Ввод DMX сети</i><br>
Тип:
<select name=DI onchange="SP(); adj();">
<option value=5568>E1.31 (sACN)</option>
<option value=6454>Art-сеть</option>
<option value=0 selected>Польз. порт</option>
</select><br>
<div id=xp>Порт: <input name="EP" type="number" min="1" max="65535" value="5568" class="d5" required><br></div>
Мультикаст: <input type="checkbox" name="EM"><br>
Начать вселенную: <input name="EU" type="number" min="0" max="63999" required><br>
<i>Требуется перезапуск.</i> Проверить <a href="https://github.com/LedFx/LedFx" target="_blank">LedFx</a>!<br>
Пропускать внеочередные пакеты: <input type="checkbox" name="ES"><br>
Начальный адрес DMX: <input name="DA" type="number" min="1" max="510" required><br>
DMX пропуски сегментов: <input name="XX" type="number" min="0" max="150" required><br>
E1.31 приоритеты портов: <input name="PY" type="number" min="0" max="200" required><br>
DMX режим:
<select name=DM>
<option value=0>Деактивированный</option>
<option value=1>Один RGB</option>
<option value=2>Один DRGB</option>
<option value=3>Эффект</option>
<option value=7>Эффект + Белый</option>
<option value=8>Эффект сегмент</option>
<option value=9>Эффект сегмент + Белый</option>
<option value=4>Множество RGB</option>
<option value=5>Диммер + Множество RGB</option>
<option value=6>Множество RGBW</option>
<option value=10>Пресет</option>
</select><br>
<a href="https://kno.wled.ge/interfaces/e1.31-dmx/" target="_blank">E1.31 инфо</a><br>
Таймер: <input name="ET" type="number" min="1" max="65000" required> ms<br>
Насильно макс яркость: <input type="checkbox" name="FB"><br>
Деактир. коррекцию гаммы в реальном времени<input type="checkbox" name="RG"><br>
Смещение LED в реальном времени: <input name="WO" type="number" min="-255" max="255" required>
<hr class="sml">
<h3>Помощник Алекса</h3>
<div id="NoAlexa" class="hide">
	<i class="warn">Эта сбобрка не включает Алексу.<br></i><br>
</div>
<div id="Alexa">
Эмулировать Алексу: <input type="checkbox" name="AL"><br>
Имя призыва Алексы: <input type="text" name="AI" maxlength="32"><br>
Также эмулировать первичный вызов Алексы устройством <input name="AP" type="number" class="s" min="0" max="9" required> пресеты<br><br>
</div>
<hr class="sml">
<div class="warn">&#9888; <b>MQTT и Hue синхронизация всех подключенных ко внешним хостам!<br>
Это может вызвать безотзывчивость устройства.</b><br>
</div>
Рекомендуется использовать только один сервис.<br>
(можно подключить второй ESP и использовать UDP синхронизацию)
<hr class="sml">
<h3>MQTT</h3>
<div id="NoMQTT" class="hide">
	<i class="warn">Эта сборка не включает MQTT.<br></i>
</div>
<div id="MQTT">
Включить MQTT: <input type="checkbox" name="MQ"><br>
Брокер: <input type="text" name="MS" maxlength="32">
Порт: <input name="MQPORT" type="number" min="1" max="65535" class="d5"><br>
<b>MQTT реквизиты отправлены по незащищенному каналу.<br>
Не используйте MQTT пароль для других сервисов!</b><br>
Логин: <input type="text" name="MQUSER" maxlength="40"><br>
Пароль: <input type="password" name="MQPASS" maxlength="64"><br>
ID клиента: <input type="text" name="MQCID" maxlength="40"><br>
Топик устройства: <input type="text" name="MD" maxlength="32"><br>
Топик группы: <input type="text" name="MG" maxlength="32"><br>
Опубликовать на кнопку: <input type="checkbox" name="BM"><br>
Удерживать яркость и сообщения цветов: <input type="checkbox" name="RT"><br>
<i>Для применения изменений требуется перезапуск. </i><a href="https://kno.wled.ge/interfaces/mqtt/" target="_blank">MQTT инфо</a>
</div>
<h3>Philips Hue</h3>
<div id="NoHue" class="hide">
	<em class="warn">Сборка не включает Philips Hue.<br></em>
</div>
<div id="Hue">
<i>Вы можете найти мостовой IP и номер подсветки в разделе "О программе" приложения.</i><br>
Опрашивать Poll Hue <input name="HL" type="number" min="1" max="99" > каждые <input name="HI" type="number" min="100" max="65000"> мс: <input type="checkbox" name="HP"><br>
Затем, получать <input type="checkbox" name="HO"> Вкл/Выкл, <input type="checkbox" name="HB"> Яркость, и <input type="checkbox" name="HC"> Цвет<br>
Hue мостовой IP:<br>
<input name="H0" type="number" class="s" min="0" max="255" > .
<input name="H1" type="number" class="s" min="0" max="255" > .
<input name="H2" type="number" class="s" min="0" max="255" > .
<input name="H3" type="number" class="s" min="0" max="255" ><br>
<b>Нажмите кнопку push link на мосту, после чего сохраните эту страницу!</b><br>
(при первом соединении)<br>
Hue статус: <span class="sip"> Неактивный в этой сборке </span>
</div>
<h3>Серийник</h3>
Baud частота:
<select name=BD>
<option value=1152>115200</option>
<option value=2304>230400</option>
<option value=4608>460800</option>
<option value=5000>500000</option>
<option value=5760>576000</option>
<option value=9216>921600</option>
<option value=10000>1000000</option>
<option value=15000>1500000</option>
</select><br>
<i>Держите на 115200 чтобы использовать Improv. Некоторые платформы не поддерживают высокие частоты.</i>
<hr>
<button type="button" onclick="B()">Назад</button><button type="submit">Сохранить</button>
</form>
</body>
</html>